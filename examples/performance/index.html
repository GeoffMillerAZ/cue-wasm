<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUE-WASM Mission Control v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/bin/wasm_exec.js"></script>
    <style>
        [hidden] { display: none !important; }
        .metric-card { transition: all 0.2s ease; }
        .rating-ultra { border-color: #10b981; background-color: #ecfdf5; color: #065f46; }
        .rating-fast { border-color: #3b82f6; background-color: #eff6ff; color: #1e40af; }
        .rating-ok { border-color: #f59e0b; background-color: #fffbeb; color: #92400e; }
        .rating-slow { border-color: #ef4444; background-color: #fef2f2; color: #991b1b; }
    </style>
</head>
<body class="h-full overflow-hidden">
    <div id="app" class="flex h-full">
        <!-- Sidebar -->
        <div class="w-72 bg-gray-900 text-white flex flex-col flex-shrink-0">
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-indigo-500 shadow-[0_0_8px_rgba(99,102,241,0.8)]"></div>
                    <h1 class="text-xl font-bold tracking-tight">CUE-LAB</h1>
                </div>
                <p class="text-[10px] text-gray-500 mt-1 font-mono uppercase tracking-widest">WASM Performance Profiler</p>
            </div>
            
            <nav class="flex-1 overflow-y-auto p-4 space-y-6 flex flex-col">
                <div>
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Runtime Control</h3>
                    <div class="space-y-3">
                        <button onclick="window.clearCache()" class="w-full flex items-center justify-center gap-2 bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500/20 px-3 py-2 rounded-md text-xs font-semibold transition-all">
                            <svg class="size-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            Purge & Cold Start
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Benchmark Scenarios</h3>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="window.loadScenario('kubernetes')" class="group flex items-center justify-between px-3 py-2 rounded-md text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white transition-all">
                            Kubernetes Cluster
                            <span class="text-[10px] text-gray-600 group-hover:text-indigo-400">Complex</span>
                        </button>
                        <button onclick="window.loadScenario('policy')" class="group flex items-center justify-between px-3 py-2 rounded-md text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white transition-all">
                            Policy Engine
                            <span class="text-[10px] text-gray-600 group-hover:text-indigo-400">Security</span>
                        </button>
                        <button onclick="window.loadScenario('data')" class="group flex items-center justify-between px-3 py-2 rounded-md text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white transition-all">
                            Matrix Generation
                            <span class="text-[10px] text-gray-600 group-hover:text-indigo-400">Compute</span>
                        </button>
                    </div>
                </div>

                <!-- Intelligence Glossary -->
                <div class="bg-indigo-500/5 rounded-lg border border-indigo-500/10 p-3">
                    <h3 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2 flex items-center gap-1">
                        <svg class="size-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                        Scoring Guide
                    </h3>
                    <ul class="space-y-3">
                        <li>
                            <div class="text-[10px] font-bold text-gray-300">ULTRA (< 100ms)</div>
                            <p class="text-[9px] text-gray-500 leading-tight">Perceived as instant. The "Gold Standard" for UI responsiveness.</p>
                        </li>
                        <li>
                            <div class="text-[10px] font-bold text-gray-300">FAST (100-300ms)</div>
                            <p class="text-[9px] text-gray-500 leading-tight">Snappy. Comparable to a fast API request over fiber.</p>
                        </li>
                        <li>
                            <div class="text-[10px] font-bold text-gray-300">OK (300-1000ms)</div>
                            <p class="text-[9px] text-gray-500 leading-tight">Acceptable for heavy background boot (Engine load).</p>
                        </li>
                    </ul>
                </div>

                <div class="flex-1"></div>
                
                <div>
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Internal Telemetry</h3>
                    <div id="logs" class="h-48 overflow-y-auto bg-black/50 border border-gray-800 rounded p-2 font-mono text-[9px] text-indigo-400 space-y-1">
                    </div>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-800 bg-black/20">
                <div id="status-indicator" class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span class="text-[10px] font-mono text-gray-400 uppercase tracking-tighter">System Link Offline</span>
                    </div>
                    <span class="text-[9px] font-mono text-gray-600">v1.4.0</span>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- Metrics v2 -->
            <div class="bg-white border-b border-gray-200 p-4 shadow-sm z-10">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-bold text-gray-900 uppercase tracking-tight">Performance Telemetry</h2>
                    <div class="flex items-center gap-4 text-[10px] font-bold">
                        <span class="flex items-center gap-1 text-emerald-600"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> ULTRA</span>
                        <span class="flex items-center gap-1 text-blue-600"><div class="w-2 h-2 rounded-full bg-blue-500"></div> FAST</span>
                        <span class="flex items-center gap-1 text-amber-600"><div class="w-2 h-2 rounded-full bg-amber-500"></div> OK</span>
                        <span class="flex items-center gap-1 text-red-600"><div class="w-2 h-2 rounded-full bg-red-500"></div> SLOW</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <!-- Phase 1: Reader -->
                    <div id="card-reader" class="metric-card border rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-black uppercase opacity-60">Phase 1: Reader</span>
                            <span id="rate-reader" class="text-[9px] px-1.5 py-0.5 rounded-full border font-bold">--</span>
                        </div>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-2xl font-black" id="val-reader-time">--</span>
                            <span class="text-xs opacity-60">ms</span>
                        </div>
                        <div class="mt-1 text-[10px] font-mono opacity-50" id="val-reader-size">Size: 5.2 MB</div>
                    </div>

                    <!-- Phase 2: Engine -->
                    <div id="card-engine" class="metric-card border rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-black uppercase opacity-60">Phase 2: Engine</span>
                            <span id="rate-engine" class="text-[9px] px-1.5 py-0.5 rounded-full border font-bold">--</span>
                        </div>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-2xl font-black" id="val-engine-time">--</span>
                            <span class="text-xs opacity-60">ms</span>
                        </div>
                        <div class="mt-1 text-[10px] font-mono opacity-50" id="val-engine-size">Size: 27.1 MB</div>
                    </div>

                    <!-- Phase 3: Intelligence -->
                    <div id="card-intel" class="metric-card border rounded-xl p-4">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-black uppercase opacity-60">Phase 3: Logic Latency</span>
                            <span id="rate-intel" class="text-[9px] px-1.5 py-0.5 rounded-full border font-bold">--</span>
                        </div>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-2xl font-black" id="val-intel-time">--</span>
                            <span class="text-xs opacity-60">ms</span>
                        </div>
                        <div class="mt-1 flex items-center justify-between">
                            <span class="text-[10px] font-mono opacity-50">Local Processing</span>
                            <span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-1 rounded">10x Faster than API</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Editor / Result -->
            <div class="flex-1 flex overflow-hidden bg-gray-100 p-4 gap-4">
                <div class="flex-1 flex flex-col rounded-xl bg-white shadow-xl ring-1 ring-black/5 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Input Editor</span>
                        <span id="syntax-badge" class="px-2 py-0.5 rounded text-[9px] font-black tracking-tighter bg-gray-200 text-gray-500 uppercase">Idle</span>
                    </div>
                    <textarea id="editor" class="flex-1 p-6 font-mono text-sm resize-none outline-none leading-relaxed" spellcheck="false"></textarea>
                </div>

                <div class="w-[400px] flex flex-col gap-4">
                    <div class="flex-1 rounded-xl bg-gray-900 shadow-xl overflow-hidden flex flex-col">
                        <div class="bg-gray-800 px-4 py-2 border-b border-gray-700">
                            <span class="text-[10px] font-bold text-gray-400 uppercase">Output JSON</span>
                        </div>
                        <pre id="output" class="flex-1 p-6 font-mono text-[11px] overflow-auto text-emerald-400 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadWasmWorker, Workspace } from '/dist/index.js';

        const ws = new Workspace();
        let cue = null;
        let startTime = Date.now();
        let firstParseRecorded = false;

        const ui = {
            tti: document.getElementById('val-reader-time'),
            engine: document.getElementById('val-engine-time'),
            intel: document.getElementById('val-intel-time'),
            status: document.getElementById('status-indicator'),
            badge: document.getElementById('syntax-badge'),
            logs: document.getElementById('logs'),
            cards: {
                reader: document.getElementById('card-reader'),
                engine: document.getElementById('card-engine'),
                intel: document.getElementById('card-intel')
            },
            rates: {
                reader: document.getElementById('rate-reader'),
                engine: document.getElementById('rate-engine'),
                intel: document.getElementById('rate-intel')
            }
        };

        const editor = document.getElementById('editor');
        const output = document.getElementById('output');

        function getRating(ms) {
            if (ms < 100) return { label: 'ULTRA', class: 'rating-ultra' };
            if (ms < 300) return { label: 'FAST', class: 'rating-fast' };
            if (ms < 1000) return { label: 'OK', class: 'rating-ok' };
            return { label: 'SLOW', class: 'rating-slow' };
        }

        function updateCard(type, ms) {
            const rating = getRating(ms);
            const card = ui.cards[type];
            const rate = ui.rates[type];
            
            card.className = `metric-card border rounded-xl p-4 ${rating.class} shadow-sm`;
            rate.textContent = rating.label;
            rate.className = `text-[9px] px-1.5 py-0.5 rounded-full border border-current font-bold`;
        }

        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type === 'error' ? 'text-red-400' : 'text-indigo-300';
            entry.textContent = `> ${msg}`;
            ui.logs.appendChild(entry);
            ui.logs.scrollTop = ui.logs.scrollHeight;
        }

        const scenarios = {
            kubernetes: `package k8s\n\ndeployment: {\n    apiVersion: "apps/v1"\n    kind:       "Deployment"\n    metadata: name: "nginx-deployment"\n    spec: {\n        replicas: 3\n        selector: matchLabels: app: \"nginx\"\n        template: {\n            metadata: labels: app: \"nginx\"\n            spec: containers: [{\n                name:  \"nginx\"\n                image: \"nginx:1.14.2\"\n                ports: [{containerPort: 80}]\n            }]\n        }\n    }\n}`,
            policy: `#User: {\n    name: string\n    age:  int & >= 18\n}\n\ndata: users: [\n    { name: \"Alice\", age: 30 },\n    { name: \"Bob\",   age: 10 }, // Fails\n]`,
            data: `// Computation Matrix\nresults: [for x in [1, 2, 3, 4, 5] { \n    id: x\n    val: x * x\n    label: "Result #\\(x)"\n}]`
        };

        async function init() {
            log("System Bootstrapping...");
            updateStatus('loading', 'System Booting');

            try {
                const options = {
                    workerPath: '/dist/worker.js',
                    readerPath: '/bin/cue-reader.wasm',
                    enginePath: '/bin/cue-engine.wasm',
                    wasmExecPath: '/bin/wasm_exec.js'
                };

                log("Phase 1: Deploying Reader...");
                const rStart = Date.now();
                cue = await loadWasmWorker(options);
                const rTime = Date.now() - rStart;
                
                ui.tti.textContent = rTime;
                updateCard('reader', rTime);
                log(`Reader active in ${rTime}ms`);
                updateStatus('reader', 'Reader Active');

                // Auto-load scenario
                window.loadScenario('kubernetes');

                // Background track for engine
                log("Phase 2: Initializing Evaluator...");
                const eStart = Date.now();
                // We'll detect engine ready by polling or waiting for first successful unify
                // The worker-manager handles the background init call automatically.
                
                updateStatus('ready', 'Mission Link Active');
            } catch (e) {
                log("SYSTEM CRASH: " + e.message, "error");
                updateStatus('error', 'Critical Failure');
            }
        }

        window.loadScenario = (name) => {
            log(`Loading: ${name}`);
            editor.value = scenarios[name] || '';
            runPipeline();
        };

        window.clearCache = async () => {
            log("Purging Caches...");
            await indexedDB.deleteDatabase('CUE_WASM_CACHE');
            location.reload();
        };

        async function runPipeline() {
            if (!cue) return;
            const code = editor.value;
            ws.addFile('/input.cue', code, true);

            // Phase 3: Intel (Parse)
            const pStart = Date.now();
            try {
                const syntax = await ws.validateSyntax('/input.cue', cue);
                const pTime = Date.now() - pStart;
                
                if (!firstParseRecorded) {
                    ui.intel.textContent = pTime;
                    updateCard('intel', pTime);
                    firstParseRecorded = true;
                }

                if (syntax.valid) {
                    ui.badge.textContent = "Syntax: Secure";
                    ui.badge.className = "px-2 py-0.5 rounded text-[9px] font-black bg-emerald-100 text-emerald-700 uppercase";
                } else {
                    ui.badge.textContent = "Syntax: Breach";
                    ui.badge.className = "px-2 py-0.5 rounded text-[9px] font-black bg-red-100 text-red-700 uppercase";
                }
            } catch (e) { log("Parse Error: " + e.message, "error"); }

            // Unify
            const uStart = Date.now();
            try {
                const res = await cue.unify(ws.getOverlay(), ['/input.cue']);
                output.textContent = JSON.stringify(JSON.parse(res), null, 2);
                output.className = "flex-1 p-6 font-mono text-[11px] overflow-auto text-emerald-400";
                
                // If engine was '--', mark it ready
                if (ui.engine.textContent === '--') {
                    const eTime = Date.now() - startTime;
                    ui.engine.textContent = eTime;
                    updateCard('engine', eTime);
                    log(`Full Engine ready in ${eTime}ms`);
                }
            } catch (e) {
                const msg = e.message || e;
                if (msg.includes("requires the Full Engine")) {
                    output.textContent = "[SYSTEM] Evaluator is warming up...";
                    output.className = "flex-1 p-6 font-mono text-[11px] overflow-auto text-indigo-400 italic";
                } else {
                    output.textContent = msg;
                    output.className = "flex-1 p-6 font-mono text-[11px] overflow-auto text-red-400";
                }
            }
        }

        function updateStatus(state, msg) {
            const dot = ui.status.querySelector('div');
            const text = ui.status.querySelector('span');
            text.textContent = msg;
            dot.className = "w-2 h-2 rounded-full " + (
                state === 'loading' ? 'bg-yellow-500 animate-pulse shadow-[0_0_8px_#f59e0b]' :
                state === 'reader' ? 'bg-blue-500 shadow-[0_0_8px_#3b82f6]' :
                state === 'ready' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' :
                'bg-red-500 shadow-[0_0_8px_#ef4444]'
            );
        }

        let debounce;
        editor.addEventListener('input', () => {
            clearTimeout(debounce);
            debounce = setTimeout(runPipeline, 100);
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>